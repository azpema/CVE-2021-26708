// CVE-2021-26708
//
// Affected functions:
//   vsock_poll()
//   vsock_dgram_sendmsg()
//   vsock_stream_setsockopt()
//   vsock_stream_sendmsg()
//   vsock_stream_recvmsg()
//
// When any of the above mentioned functions are executed the pointer of vsock_sock.transport is copied to a local variable
// before calling lock_sock(). However the value of vsock_sock.transport may change inbetween, resulting in a race condition.
//
// The value of vsock_sock.transport may be changed in the following functions:
//   vsock_assign_transport(), called in functions    ->    vsock_stream_connect()
//   												        vsock_create()
//
//   vsock_deassign_transport(), called in functions  ->    vsock_assign_transport()
//															vsock_sk_destruct()

#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <linux/vm_sockets.h>


int main(int argc, char *argv[]){
	int s;
	struct sockaddr_vm addr;
	printf("[+] Creating VSOCK\n");
	s = socket(AF_VSOCK, SOCK_STREAM, 0);

	memset(&addr, 0, sizeof(struct sockaddr_vm));
	addr.svm_family = AF_VSOCK;
	addr.svm_port = 1234;
	addr.svm_cid = VMADDR_CID_HOST; //VMADDR_CID_ANY; 

    printf("[+] Binding VSOCK to host\n");
	bind(s, (struct sockaddr*) &addr, sizeof(addr));


	close(s);

}